<%# app/views/validation/show.html.erb %>
<div class="container-fluid py-4">
  <!-- Хлібні крихти (вирівняні під ліву колонку) -->
  <div class="row justify-content-center">
    <div class="col-12 col-xxl-10">
      <nav aria-label="breadcrumb" class="mb-4 breadcrumb-container">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><%= link_to 'Головна', root_path, class: "text-decoration-none text-primary" %></li>
          <li class="breadcrumb-item"><%= link_to 'Завантаження', new_file_upload_path, class: "text-decoration-none text-primary" %></li>
          <li class="breadcrumb-item active">Валідація</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-12 col-xxl-10">
      <div class="row g-4">
        <!-- Ліва колонка -->
        <div class="col-md-4 col-lg-3">
          <!-- Інформація про файл -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>Інформація про файл
              </h5>
            </div>
            <div class="card-body">
              <dl class="row mb-0 small">
                <dt class="col-5 text-muted">Назва</dt>
                <dd class="col-7 text-truncate mb-2"><%= @uploaded_file.original_file.filename %></dd>

                <dt class="col-5 text-muted">Тип</dt>
                <dd class="col-7 mb-2"><%= @uploaded_file.original_file.content_type %></dd>

                <dt class="col-5 text-muted">Розмір</dt>
                <dd class="col-7 mb-2"><%= number_to_human_size(@uploaded_file.original_file.byte_size) %></dd>

                <dt class="col-5 text-muted">Завантажено</dt>
                <dd class="col-7 mb-2"><%= time_ago_in_words(@uploaded_file.created_at) %> тому</dd>

                <dt class="col-5 text-muted">Загалом рядків</dt>
                <dd class="col-7 mb-0"><span class="badge bg-secondary rounded-pill"><%= @total_in || 0 %></span></dd>
              </dl>
            </div>
          </div>

          <%# -------- Підготовка чисел і відсотків -------- %>
          <% v = (@valid_count || 0).to_i
             i = (@invalid_count || 0).to_i
             d = (@dup_count || 0).to_i
             x = (@dns_count || 0).to_i
             r = (@role_count || 0).to_i
             total = (@total_in || 0).to_i

             pct_total = ->(n){ total > 0 ? ((n.to_f / total) * 100.0).round : 0 }
             pct_valid   = pct_total.(v)
             pct_invalid = pct_total.(i)
          %>

          <!-- Результат перевірки -->
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-list-check me-2"></i>Результат перевірки
              </h5>
            </div>

            <!-- Верхня смужка-статистика: лише Валідні vs Невалідні -->
            <div class="px-3 pt-3">
              <div class="small text-muted d-flex align-items-center gap-3 flex-wrap">
                <span>Разом: <span class="fw-semibold text-dark"><%= total %></span></span>
                <span class="text-success">Валідні: <strong><%= v %></strong> (<%= pct_valid %>%)</span>
                <span class="text-danger">Невалідні: <strong><%= i %></strong> (<%= pct_invalid %>%)</span>
              </div>
              <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: <%= pct_valid %>%;" aria-label="valid"></div>
                <div class="progress-bar bg-danger"  role="progressbar" style="width: <%= pct_invalid %>%;" aria-label="invalid"></div>
              </div>
            </div>

            <!-- Чипи для категорій -->
            <div class="card-body pb-2">
              <div class="row g-2 validation-stats">
                <div class="col-6">
                  <div class="stat-chip chip-valid">
                    <i class="bi bi-check2-circle me-1"></i>
                    Валідні
                    <span class="ms-auto fw-semibold"><%= v %></span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-chip chip-invalid">
                    <i class="bi bi-x-circle me-1"></i>
                    Невалідні
                    <span class="ms-auto fw-semibold"><%= i %></span>
                  </div>
                </div>

                <div class="col-6">
                  <div class="stat-chip chip-dup">
                    <i class="bi bi-files me-1"></i>
                    Дублікати
                    <span class="ms-auto fw-semibold"><%= d %></span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-chip chip-dns">
                    <i class="bi bi-globe2 me-1"></i>
                    DNS
                    <span class="ms-auto fw-semibold"><%= x %></span>
                  </div>
                </div>

                <div class="col-12">
                  <div class="stat-chip chip-role">
                    <i class="bi bi-person-gear me-1"></i>
                    Службові
                    <span class="ms-auto fw-semibold"><%= r %></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Клікабельні категорії -->
            <div class="card-body pt-2">
              <div class="list-group list-group-flush validation-links">
                <!-- Валідні -->
                <%= link_to validation_path(file_id: @uploaded_file.id, scope: 'valid'),
                  class: "list-group-item list-group-item-action d-flex align-items-center gap-3 py-2 px-0 border-0 mb-2 rounded #{'active soft-active valid' if @current_scope == 'valid'} #{'disabled pe-none text-muted' unless @processed}" do %>
                  <span class="dot dot-valid"></span>
                  <span class="flex-grow-1">Валідні</span>
                  <span class="badge count-badge valid"><%= v %></span>
                  <span class="pct text-muted"><%= pct_total.(v) %>%</span>
                <% end %>

                <!-- Невалідні -->
                <%= link_to validation_path(file_id: @uploaded_file.id, scope: 'invalid'),
                  class: "list-group-item list-group-item-action d-flex align-items-center gap-3 py-2 px-0 border-0 mb-2 rounded #{'active soft-active invalid' if @current_scope == 'invalid'} #{i.zero? ? 'disabled pe-none text-muted' : ''}" do %>
                  <span class="dot dot-invalid"></span>
                  <span class="flex-grow-1">Невалідні</span>
                  <span class="badge count-badge invalid"><%= i %></span>
                  <span class="pct text-muted"><%= pct_total.(i) %>%</span>
                <% end %>

                <!-- Дублікати -->
                <%= link_to validation_path(file_id: @uploaded_file.id, scope: 'duplicates'),
                  class: "list-group-item list-group-item-action d-flex align-items-center gap-3 py-2 px-0 border-0 mb-2 rounded #{'active soft-active dup' if @current_scope == 'duplicates'} #{d.zero? ? 'disabled pe-none text-muted' : ''}" do %>
                  <span class="dot dot-dup"></span>
                  <span class="flex-grow-1">Дублікати</span>
                  <span class="badge count-badge dup"><%= d %></span>
                  <span class="pct text-muted"><%= pct_total.(d) %>%</span>
                <% end %>

                <!-- DNS (локальна+online) -->
                <%= link_to validation_path(file_id: @uploaded_file.id, scope: 'dns'),
                  class: "list-group-item list-group-item-action d-flex align-items-center gap-3 py-2 px-0 border-0 mb-2 rounded #{'active soft-active dns' if @current_scope == 'dns'} #{x.zero? ? 'disabled pe-none text-muted' : ''}" do %>
                  <span class="dot dot-dns"></span>
                  <span class="flex-grow-1">DNS</span>
                  <span class="badge count-badge dns"><%= x %></span>
                  <span class="pct text-muted"><%= pct_total.(x) %>%</span>
                <% end %>

                <!-- Службові -->
                <%= link_to validation_path(file_id: @uploaded_file.id, scope: 'role'),
                  class: "list-group-item list-group-item-action d-flex align-items-center gap-3 py-2 px-0 border-0 rounded #{'active soft-active role' if @current_scope == 'role'} #{r.zero? ? 'disabled pe-none text-muted' : ''}" do %>
                  <span class="dot dot-role"></span>
                  <span class="flex-grow-1">Службові</span>
                  <span class="badge count-badge role"><%= r %></span>
                  <span class="pct text-muted"><%= pct_total.(r) %>%</span>
                <% end %>
              </div>

              <div class="mt-3 text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                Натисніть на категорію, щоб побачити відповідний список у центральному блоці.
              </div>
            </div>
          </div>
        </div>

        <!-- Центральна колонка (перегляд) -->
        <div class="col-md-8 col-lg-5">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3 sticky-top preview-toolbar">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <h5 class="mb-0 text-primary d-flex align-items-center gap-2">
                  <i class="bi bi-file-earmark-text"></i>
                  <% title =
                    case @current_scope
                    when 'valid'      then 'Вміст — Валідні'
                    when 'invalid'    then 'Вміст — Невалідні'
                    when 'duplicates' then 'Вміст — Дублікати'
                    when 'dns'        then 'Вміст — DNS'
                    when 'role'       then 'Вміст — Службові'
                    else                   'Вміст файлу'
                    end %>
                  <%= title %>
                </h5>

                <div class="d-flex align-items-center gap-2">
                  <span class="text-muted small">
                    <% if @preview_lines&.any? %>
                      <%= @preview_lines.size %> рядків
                      <% if (@preview_total || 0) > @preview_lines.size %>
                        з <%= @preview_total %>
                      <% end %>
                    <% else %>
                      Немає даних
                    <% end %>
                  </span>

                  <div class="vr d-none d-md-block"></div>

                  <div class="btn-group btn-group-sm" role="group" aria-label="Дії">
                    <button class="btn btn-outline-secondary" onclick="copyToClipboard(this)" title="Копіювати вміст">
                      <i class="bi bi-clipboard"></i>
                    </button>

                    <button class="btn btn-outline-secondary" id="toggleWrapBtn" data-wrapped="true" type="button" title="Перенос рядків увімк/вимк">
                      <i class="bi bi-text-paragraph"></i>
                    </button>

                    <%= link_to download_validation_path(file_id: @uploaded_file.id),
                      class: "btn btn-outline-primary #{'disabled' unless @processed}",
                      title: (@processed ? 'Завантажити оброблений TXT' : 'Доступно після обробки'),
                      aria: { disabled: (!@processed).to_s } do %>
                      <i class="bi bi-download"></i> TXT
                    <% end %>

                    <button class="btn btn-outline-secondary" disabled title="Незабаром">
                      <i class="bi bi-download"></i> CSV
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              <% if @preview_lines&.any? %>
                <div class="preview-container">
                  <ol class="preview-list" id="previewList">
                    <% @preview_lines.each do |line| %>
                      <li class="preview-item">
                        <span class="line-number" aria-hidden="true"></span>
                        <span class="line-content"><%= line %></span>
                      </li>
                    <% end %>
                  </ol>
                </div>
              <% else %>
                <div class="py-5 text-center text-muted">
                  <i class="bi bi-inbox display-4 d-block mb-2"></i>
                  Немає даних для відображення
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Права колонка -->
        <div class="col-lg-4 col-12">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>Фільтри перевірки
              </h5>
            </div>
            <div class="card-body">
              <%= form_with url: process_validation_path(file_id: @uploaded_file.id), method: :post, html: { id: 'validationForm', class: 'd-flex flex-column gap-3' } do |f| %>
                <div class="form-check form-switch">
                  <%= f.check_box :remove_duplicates, class: 'form-check-input filter-toggle', id: 'filterRemoveDuplicates', role: "switch" %>
                  <%= f.label :remove_duplicates, "Видалити дублікати", class: 'form-check-label fw-bold' %>
                </div>

                <div class="form-check form-switch">
                  <%= f.check_box :dns_local, class: 'form-check-input filter-toggle', id: 'filterDnsLocal', role: "switch" %>
                  <%= f.label :dns_local, "DNS (локальна перевірка)", class: 'form-check-label fw-bold' %>
                  <div class="form-text text-muted small">Пропускаємо лише домени з білого списку (gmail.com, yahoo.com, …)</div>
                </div>

                <div class="form-check form-switch">
                  <%= f.check_box :dns_online, class: 'form-check-input filter-toggle', id: 'filterDnsOnline', role: "switch" %>
                  <%= f.label :dns_online, "DNS online (живі MX-запити)", class: 'form-check-label fw-bold' %>
                  <div class="form-text text-muted small">Повільніше: робимо MX-запити до кожного домену</div>
                </div>

                <div class="form-check form-switch">
                  <%= f.check_box :role_based, class: 'form-check-input filter-toggle', id: 'filterRoleBased', role: "switch" %>
                  <%= f.label :role_based, "Службові адреси", class: 'form-check-label fw-bold' %>
                  <div class="form-text text-muted small">Відсіюємо адреси типу support@, info@, *shop*@ тощо</div>
                </div>

                <div class="alert alert-warning p-2 small mb-0" id="filtersHint">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  Оберіть хоча б один фільтр, щоб запустити перевірку
                </div>

                <%= f.submit "Запустити перевірку", class: 'btn btn-primary w-100 mt-2 py-2 fw-bold', id: 'runValidationBtn', disabled: true, data: { disable_with: '<i class="bi bi-hourglass-split me-1"></i>Виконується…' } %>
              <% end %>
            </div>
          </div>
        </div>

      </div> <!-- /row -->
    </div>   <!-- /col wrapper -->
  </div>     <!-- /row -->
</div>       <!-- /container -->

<%# ---------- СТИЛІ ---------- %>
<style>
  .breadcrumb-container { padding-left: .75rem; padding-right: .75rem; }
  @media (min-width: 768px) { .breadcrumb-container { padding-left: 0; padding-right: 0; } }

  .preview-toolbar { z-index: 1; border-bottom: 1px solid #eef0f2; }

  .preview-container {
    max-height: 520px;
    overflow: auto;
    background: #f8f9fa;
    border-top: 1px solid #eef0f2;
  }
  .preview-container::-webkit-scrollbar { width: 8px; height: 8px; }
  .preview-container::-webkit-scrollbar-track { background: #f1f1f1; }
  .preview-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
  .preview-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

  .preview-list {
    counter-reset: line;
    margin: 0; padding: 0; list-style: none;
    font-family: 'Fira Code','Roboto Mono',Consolas,monospace;
    font-size: 13px; line-height: 1.45;
  }
  .preview-item { display: grid; grid-template-columns: 64px 1fr; gap: 0; border-bottom: 1px solid #e9ecef; }
  .preview-item:hover { background-color: #f0f2f5; }
  .preview-item .line-number {
    background: #f1f3f4; border-right: 1px solid #dee2e6;
    padding: 6px 12px 6px 8px; text-align: right; color: #6c757d; user-select: none;
  }
  .preview-item .line-number::before { counter-increment: line; content: counter(line); }
  .preview-item .line-content { padding: 6px 12px; white-space: pre-wrap; word-break: break-word; }
  .no-wrap .preview-item .line-content { white-space: pre; overflow-x: auto; }

  /* Чипи */
  .validation-stats .stat-chip {
    display: flex; align-items: center; gap: .25rem;
    padding: .5rem .6rem; border-radius: .65rem; font-size: .875rem;
    border: 1px solid transparent; background-clip: padding-box;
  }
  .stat-chip i { opacity: .9; }
  .chip-valid  { background: rgba(25,135,84,.08);  color: #155d41; border-color: rgba(25,135,84,.18); }
  .chip-invalid{ background: rgba(220,53,69,.08);  color: #7f1d1d; border-color: rgba(220,53,69,.18); }
  .chip-dup    { background: rgba(255,193,7,.10); color: #7a5b00; border-color: rgba(255,193,7,.22); }
  .chip-dns    { background: rgba(13,202,240,.10);color: #0b5e75; border-color: rgba(13,202,240,.22); }
  .chip-role   { background: rgba(111,66,193,.10); color: #4b2d7f; border-color: rgba(111,66,193,.22); }

  /* Клікабельні категорії */
  .validation-links .list-group-item {
    background: #fff; border: 1px solid #eef0f2 !important;
    padding-left: .5rem; padding-right: .5rem;
    transition: background .15s, border-color .15s, transform .05s;
  }
  .validation-links .list-group-item:hover { background: #f8fafc; border-color: #e2e6ea !important; }
  .validation-links .list-group-item .dot { width: .6rem; height: .6rem; border-radius: 50%; display: inline-block; }
  .dot-valid  { background: #198754; }
  .dot-invalid{ background: #dc3545; }
  .dot-dup    { background: #ffc107; }
  .dot-dns    { background: #0dcaf0; }
  .dot-role   { background: #6f42c1; }

  .count-badge { font-weight: 600; border-radius: .5rem; min-width: 2.25rem; text-align: center; }
  .count-badge.valid   { background: rgba(25,135,84,.12);  color: #155d41; }
  .count-badge.invalid { background: rgba(220,53,69,.12);  color: #7f1d1d; }
  .count-badge.dup     { background: rgba(255,193,7,.18);  color: #7a5b00; }
  .count-badge.dns     { background: rgba(13,202,240,.18); color: #0b5e75; }
  .count-badge.role    { background: rgba(111,66,193,.18); color: #4b2d7f; }

  .validation-links .pct { width: 3.5ch; text-align: right; }

  /* М’яка активна підсвітка */
  .validation-links .soft-active.valid  { background: rgba(25,135,84,.10) !important; }
  .validation-links .soft-active.invalid{ background: rgba(220,53,69,.10) !important; }
  .validation-links .soft-active.dup    { background: rgba(255,193,7,.12) !important; }
  .validation-links .soft-active.dns    { background: rgba(13,202,240,.12) !important; }
  .validation-links .soft-active.role   { background: rgba(111,66,193,.12) !important; }
</style>

<%# ---------- СКРИПТИ ---------- %>
<script>
  // Кнопка активна лише коли обрано хоча б один фільтр
  document.addEventListener('DOMContentLoaded', function(){
    const checks = Array.from(document.querySelectorAll('.filter-toggle'));
    const btn = document.getElementById('runValidationBtn');
    const hint = document.getElementById('filtersHint');

    function sync() {
      const anyChecked = checks.some(cb => cb.checked);
      if (btn) btn.disabled = !anyChecked;
      if (hint) hint.style.display = anyChecked ? 'none' : 'block';
    }

    checks.forEach(cb => cb.addEventListener('change', sync));
    sync();

    // Захист від подвійного сабміту
    const form = document.getElementById('validationForm');
    if (form && btn) form.addEventListener('submit', () => btn.setAttribute('disabled', 'disabled'));

    // Перемикач переносу рядків
    const toggleWrapBtn = document.getElementById('toggleWrapBtn');
    const previewList = document.getElementById('previewList');
    if (toggleWrapBtn && previewList) {
      toggleWrapBtn.addEventListener('click', () => {
        const wrapped = toggleWrapBtn.getAttribute('data-wrapped') === 'true';
        previewList.classList.toggle('no-wrap', wrapped);
        toggleWrapBtn.setAttribute('data-wrapped', String(!wrapped));
      });
    }
  });

  // Копіювання вмісту
  function copyToClipboard(buttonEl) {
    try {
      const lineContents = Array.from(document.querySelectorAll('.line-content'))
        .map(el => el.textContent)
        .join('\n');

      navigator.clipboard.writeText(lineContents).then(() => {
        if (!buttonEl) return;
        const originalHTML = buttonEl.innerHTML;
        buttonEl.innerHTML = '<i class="bi bi-check"></i>';
        buttonEl.classList.remove('btn-outline-secondary');
        buttonEl.classList.add('btn-outline-success');

        setTimeout(() => {
          buttonEl.innerHTML = originalHTML;
          buttonEl.classList.remove('btn-outline-success');
          buttonEl.classList.add('btn-outline-secondary');
        }, 1800);
      });
    } catch (err) {
      console.error('Помилка копіювання:', err);
    }
  }
</script>
